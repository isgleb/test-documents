<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Documents component</title>
    <link rel="stylesheet" href="assets/styles/category-row.css">
    <link rel="stylesheet" href="assets/styles/search.css">
    <link rel="stylesheet" href="assets/styles/document-row.css">
    <link rel="stylesheet" href="assets/styles/commons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@500&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.5.1/knockout-latest.js" integrity="sha512-2AL/VEauKkZqQU9BHgnv48OhXcJPx9vdzxN1JrKDVc4FPU/MEE/BZ6d9l0mP7VmvLsjtYwqiYQpDskK9dG8KBA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>

<div>
    <img src="assets/icons/moveArrows.svg"/>
    <img src="assets/icons/editPencil.svg"/>
    <img src="assets/icons/deleteBucket.svg"/>
    <img src="assets/icons/tickArrow.svg"/>
    <img src="assets/icons/searchLoupe.svg"/>
</div>


<div class="wrapper">
    <h1>Документы</h1>

    <div class="search">
        <div class="search-input-wrapper">
            <img src="assets/icons/searchLoupe.svg"/>
            <input data-bind="value: searchValue" class="search-input">
        </div>
        <div data-bind="if: showClearIcon">
            <img data-bind="click: clearSearch" src="assets/icons/deleteCross.svg" class="close-icon pointer"/>
        </div>
    </div>

    <ul data-bind="foreach: categories" style="margin-top: 20px">
        <li>
            <div class="category row" data-bind="css: { 'first-row': $index() === 0 }" draggable="true">
                <div class="category-content document-content">
                    <img src="assets/icons/tickArrow.svg"  class="tick-element pointer" data-bind="click: $parent.openList, css: {'rotated': isOpen}"/>
                    <span data-bind="text: name" class="category-name"></span>
                    <span data-bind="text: comment" class="category-comment"></span>
                    <span data-bind="text: $parent.length" ></span>
                    <span data-bind="text: ($index() === $parent.length -1)" ></span>
                </div>
                <div class="document-content" data-bind="event: { dragover: $parent.stopChildPropagation }">
                    <img src="assets/icons/editPencil.svg" class="control-button pointer"/>
                    <img src="assets/icons/deleteBucket.svg" class="control-button pointer"/>
                    <img src="assets/icons/moveArrows.svg" class="control-button pointer" draggable="false" data-bind="event: {mousedown: $parent.allow}"/>
                </div>
            </div>
            <div data-bind="if: isOpen">
                <ul data-bind="foreach: documents"  class="document-ul">
                    <li class="document row" draggable="true">
                        <span class="document-content">
                            <span data-bind="text: name" class="control-button"></span>
                            <span data-bind="text: required ? requiredStr : ''" class="control-button required-field"></span>
                            <span data-bind="text: comment" class="control-button"></span>
                        </span>
                        <div class="document-content" data-bind="event: { dragover: $parent.stopChildPropagation }">
                            <img src="assets/icons/editPencil.svg" class="control-button pointer"/>
                            <img src="assets/icons/deleteBucket.svg" class="control-button pointer"/>
                            <img src="assets/icons/moveArrows.svg" class="control-button pointer" draggable="false" data-bind="event: {mousedown: $parent.allow}"/>
                        </div>
                    </li>
                </ul>
            </div>

        </li>
    </ul>

    <ul data-bind="foreach: documents">
        <li class="document row"
            data-bind="
            attr: { draggable: draggable },
            css: { 'first-row': $index() === 0 },
            event: {
                dragstart: $parent.handleDragStart,
                dragend: $parent.handleDragEnd,
                dragover: $parent.handleDragOver,
                dragenter: $parent.handleDragEnter,
                dragleave: $parent.handleDragLeave,
                drop: $parent.handleDrop
            }"
        >
            <span class="document-content" data-bind="event: { dragover: $parent.stopChildPropagation }" draggable="false">
<!--                 <span data-bind="text: $index"></span>-->
                <span data-bind="text: name" class="control-button"></span>
                <span data-bind="text: required ? requiredStr : ''" class="control-button"></span>
                <span data-bind="text: comment" class="control-button"></span>
            </span>
            <span class="document-content" data-bind="event: { dragover: $parent.stopChildPropagation }" draggable="false" >
                <img src="assets/icons/editPencil.svg" draggable="false" class="control-button pointer"/>
                <img src="assets/icons/deleteBucket.svg" draggable="false" class="control-button pointer"/>
                <img src="assets/icons/moveArrows.svg" draggable="false" class="control-button pointer" data-bind="event: {mousedown: $parent.allow}"/>
            </span>
        </li>
    </ul>
</div>
</body>

<script type='text/javascript'>

    const requiredStr = "Обязательный"


    function ReservationsViewModel() {

        this.searchValue = ko.observable("");

        this.showClearIcon = ko.computed(() => {
            return !!this.searchValue();
        }, this);

        this.isFirst = ko.pureComputed(function() {
            console.log(this)
            return true
        }, this);

        this.clearSearch = function () {
            this.searchValue("")
        }

        this.openList = function (parent){
            const isOpenNow = parent.isOpen()
            parent.isOpen(!isOpenNow)
        }

        this.categories = ko.observableArray([
            { name: "Обязательные для всех", documents: [{name:"fsgs", required: true, comment: "Для всех"}, {name:"fsgs", required: true, comment: "Для всех"}], comment: "Для всех", isOpen: ko.observable(true)},
            { name: "Обязательные для трудоустройства", documents: [{name:"fsgs", required: true, comment: "Для всех"}, {name:"fsgs", required: true, comment: "Для всех"}], comment: "Для всех" , isOpen: ko.observable(false)},
            { name: "Специальные", documents: [{name:"fsgs", required: true, comment: "Для всех"}, {name:"fsgs", required: true, comment: "Для всех"}], comment: "Для всех" , isOpen: ko.observable(false)}
        ]);
        const self = this

        self.documents = ko.observableArray([
            {name:"1", required: true, comment: "Для всех", draggable: ko.observable(false)},
            {name:"2", required: true, comment: "Для всех", draggable: ko.observable(false)},
            {name:"3", required: true, comment: "Для всех", draggable: ko.observable(false)},
        ])

        this.allow = function (data, event) {
            data.draggable(true)
            return true;
        }

        this.handleDragStart = function (data, event) {

            event.target.style.opacity = '0.4';
            const objectIndex = self.documents().findIndex(element => element === data)

            event.dataTransfer.setData('text/plain', objectIndex)
            return true;
        }

        this.stopChildPropagation = function (data,event) {
            // console.log(event.target.parentElement.classList)
            // if (event.target.parentElement.classList.contains('row')) {
            //     event.target.parentElement.classList.add('over');
            // }
            // if (event.target.parentElement.parentElement.classList.contains('row')) {
            //     event.target.parentElement.classList.add('over');
            // }
            // event.stopPropagation()
        }

        this.handleDragOver = function (data, event) {
            event.target.classList.add('over');
        }

        this.handleDragEnter = function (data, event) {
            // event.target.classList.add('over');
        }

        this.handleDragLeave = function (data, event) {
            event.target.classList.remove('over');
        }

        this.handleDragEnd = function (data, event) {
            event.target.style.opacity = '1';
            data.draggable(false)
            // event.toElement.classList.remove('over');
        }

        this.handleDrop = function(data, event) {
            event.target.classList.remove('over');

            const fromIndex = self.documents().findIndex(a=> a===data)
            const toIndex = event.dataTransfer.getData('text/plain')
            // по разному вверх и вниз, и на шаблоне как раз так, как дает функция, надо изменить отображение рамки и все

            self.documents.splice(toIndex, 0, self.documents.splice(fromIndex, 1)[0]);

            // self.documents.splice(fromIndex, 0, self.documents.splice(toIndex, 1)[0]);
            return false;
        }
    }

    ko.applyBindings(new ReservationsViewModel());
</script>
<style>
    .category{
        /*height: 48px;*/
    }


    .over{
        border-top: 2px solid red;
    }


    svg {
        width: 8px;
        height: 15px;
    }
</style>
</html>